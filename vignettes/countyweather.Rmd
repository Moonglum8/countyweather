---
title: "Using the `countyweather` package"
author: "Rachel Severson and Brooke Anderson"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r echo = FALSE}
library(countyweather)
options("noaakey" = Sys.getenv("noaakey"))
```

## Setting up to use the package

Currently, this package exists in a development version on GitHub. To use the function, you need to install it directly from GitHub using the `install_github` function from `devtools`. Further, the package relies on some functions that are in a development version of `rnoaa`, so you need to install that version of the `rnoaa` package. 

You can use the following code for this set-up: 

```{r eval = FALSE}
library(devtools)

install_github("ropenscilabs/rnoaa")
library(rnoaa)

install_github("leighseverson/countyweather")
library(countyweather)
```

You will also need an API key from NOAA to be able to access the weather data. You can get one by requesting that NOAA email you an API key from here: http://www.ncdc.noaa.gov/cdo-web/token  

Next, open a new text file (in RStudio, do this by navigating to *File* > *New File* > *Text File*). Type the following, and make sure to add a second blank line:
```{r eval = FALSE}
noaakey=your_key

```

Save this text file as `.Renviron` in your home directory. (If prompted with a complaint, you DO want to use a filename that begins with a dot `.`. Once you restart R, you can pull your key using `Sys.getenv("noaakey")`. Before using functions that require the API key, run: 

```{r}
options("noaakey" = Sys.getenv("noaakey"))
```

This package draws mainly on functions from the `rnoaa` package to identify weather monitors within a county based on its FIPS code and then pull weather data for a specified date range from those monitors. It then does some additional cleaning and aggregating to produce a single, county-level weather dataset. Further, it maps the monitors used for that county and date range and allows you to create and write datasets for many different counties using a single function call.

## Basic examples of using the package

This package allows you to pull data based on a US county's corresponding Federal Information Processing Standard (FIPS) code. FIPS codes are 5-digit codes that uniquely identify every US county. The first two digits specify state and the last three specify the county within the state. The health data used in environmental epidemiology studies is often aggregated at the county level for US studies, making it very useful to be able to create weather datasets by county. 

Currently, this package can pull daily and hourly weather data for variables like temperature and precipitation. (For resources with complete lists of available weather variables, see the section titled 'More on the weather data'). The weather data is collected at monitors, and there are often multiple weather monitors within a county. This package allows you to specify a county and then will pull weather data from all monitors in that county over a specified date range, and average the daily or hourly values to generate an average time series for that county. There is an option (`average_data = TRUE / FALSE`) that allows the user to get the data before it has been averaged across weather stations. 

The two main functions in the countyweather package are `daily_fips` and `hourly_fips`. They pull daily and hourly weather data, respectively. For more about the sources of data for these two functions, see the section titled "More about the weather data."

### Pulling daily data

Here is an example of creating a dataset with daily precipitation for Miami-Dade county (FIPS code = 12086) for August 1992, when Hurricane Andrew stuck: 

```{r warning = FALSE, message = FALSE}
andrew_precip <- daily_fips(fips = "12086", 
                            date_min = "1992-08-01", 
                            date_max = "1992-08-31",
                            var = "PRCP")
```

The output from this function call includes both the weather dataset (`andrew_precip$daily_data`) and a map showing the locations of weather monitors included in the county-averaged dataset (`anderew_precip$station_map`). 

Here are the first few rows of the dataset: 

```{r}
head(andrew_precip$daily_data)
```

The dataset includes columns for date (`date`), precipitation (in mm, `prcp`), and also the number of stations used to calculated each precipitation observation (`prcp_reporting`).

Here is a plot of this data:

```{r fig.width = 6, fig.height = 4}
library(ggplot2)
ggplot(andrew_precip$daily_data, aes(x = date, y = prcp,
                                     color = prcp_reporting)) + 
  geom_line() + 
  theme_minimal() + 
  xlab("Date in 1992") + ylab("Daily rainfall (mm)") + 
  scale_color_continuous(name = "# monitors\nreporting")
```

From this plot, you can see both the extreme precipitation associated with Hurricane Andrew and that the storm knocked out quite a few of the weather monitors normally available.

To see a map of the monitors used for the county average, run:

```{r warning = FALSE}
andrew_precip$station_map
```

### Pulling hourly data

Here is an example of pulling hourly data for Miami-Dade, again for the period around Hurricane Andrew:

```{r}
andrew_hourly <- hourly_fips(fips = "12086", year = 1992,
                           var = c("wind_speed", "temperature"))
```

The output from this call includes the date-time of the observation (given in UTC), values for the weather variables selected, and the number of monitors reporting for each observation of each weather variable: 

```{r}
head(andrew_hourly$hourly_data)
```

Here are hourly values for the month of Hurricane Andrew:

```{r fig.width = 8, fig.height = 4, message = FALSE, warning = FALSE}
library(dplyr)
library(lubridate)
to_plot <- andrew_hourly$hourly_data %>%
  filter(months(date_time) == "August")
ggplot(to_plot, aes(x = date_time, y = wind_speed,
                    color = wind_speed_reporting)) + 
  geom_line() + theme_minimal() + 
  xlab("Date in August 1992") + 
  ylab("Wind speed (m / s)") + 
  scale_color_continuous(name = "# monitors\nreporting")
```

## Futher options available in the package

### `coverage` 

For hourly and daily weather, the user can choose to filter out any monitors that report variables for less that a certain percent of time (`coverage`). For example, if you were to set `coverage` to 0.90, only monitors that reported non-missing values at least 90% of the time would be included in your data. 

### Writing out timeseries files 

There are a few functions that allow the user to write out daily or hourly timeseries datasets as RDS or CSV files to a specified local directory, as well as plots of this data. For daily weather data, see the functions \code{county_timeseries} and \code{plot_timeseries}. For hourly, see \code{hourly_timeseries} and \code{hourly_plots}. If we wanted to compare daily weather in the month of August for several counties in southern Florida, we could run: 

```{r eval = FALSE}
fl_counties <- c("12086", "12087", "12011", "12021", "12099", "12051", "12071")

daily_timeseries(fips = fl_counties, date_min = "1992-08-01", 
                 date_max = "1992-08-31", var = "PRCP", 
                 out_directory = "~/Documents/andrew_data")
```

`daily_timeseries()` saves each county's timeseries as a separate .rds file in the directory specified in the `out_directory` option. The function `plot_daily_timeseries` writes out plots for each of these .rds files. 

```{r eval = FALSE}
plot_daily_timeseries("prcp", file_directory = "~/Documents/andrew_data", 
                      plot_directory = "~/Documents/andrew_plots", 
                      date_min = "1992-08-01", date_max = "1992-08-31")
```

Here's an example of what the timeseries plot for Miami-Dade County (fips = 12086) would look like: 

```{r echo = FALSE}
df <- andrew_precip$daily_data
plot(df$date, df$prcp, type = "l", col = "red", main = "12086", xlab = "date", 
     ylab = "prcp", xlim = c(as.Date("1992-08-01"), as.Date("1992-08-31")))
```

### `average_data` 

In both `daily_fips()` and `hourly_fips()`, there is an option called `average_data` which allows the user to specify whether they would like the weather data returned before it has been averaged across monitors. The default is `average_data = TRUE`. For our Hurricane Andrew example, if we specify `average_data = FALSE`: 

```{r}
not_averaged <- daily_fips(fips = "12086", 
                            date_min = "1992-08-01", 
                            date_max = "1992-08-31",
                            var = "PRCP", average_data = FALSE)$daily_data
head(not_averaged)
unique(not_averaged$id)
```

In this example, there are six monitors contributing weather data to the timeseries. We can plot the data by station to get a sense for how values from each monitor compare, and which monitors were presumably knocked out by the storm:  

```{r fig.width = 6, fig.height = 4, warning = FALSE, message = FALSE}
library(ggplot2)
ggplot(not_averaged, aes(x = date, y = prcp, 
                         colour = id)) + 
  geom_line() + 
  theme_minimal() 
```

It might be interesting here to compare this plot with the station map, this time with station labels included:  

```{r warning = FALSE, message = FALSE}
daily_fips(fips = "12086", date_min = "1992-08-01", date_max = "1992-08-31",
           var = "PRCP", station_label = TRUE)$station_map
```

## More on the weather data

### Daily weather data 

Functions in this package that pull daily weather values (`weather_fips()`, for example) are pulling data from the Daily Global Historical Climatology Network (GHCN-Daily) through NOAA's FTP server. 

Users can specify which weather variables they would like to pull. The five core daily weather variables are precipitation (`PRCP`), snowfall (`SNOW`), snow depth (`SNWD`), maximum temperature (`TMAX`) and minimum temperature (`TMIN`). The daily weather data is filtered so that included weather variables fall within a range of possible values. These ranges were chosen to include national maximum recorded values.

```{r echo = FALSE, warning = FALSE, message = FALSE}
daily_vars <- data.frame(variables = c("PRCP", "SNOW", "SNWD", "TMAX", "TMIN"), 
                         description = c("precipitation", "snowfall", "snow depth", "maximum temperature", "minumum temperature"), 
                         units = c("mm", "mm", "mm", "degrees Celsius", "degrees Celsius"), 
                         most_extreme_value = c("1100 mm", "1600 mm", "11500 mm", "57 degrees C", "-62 degrees C"))
library(knitr)
kable(daily_vars, format = "markdown")
```

The daily weather function \code{weather_fips} defaults to pull these five core weather variables. However, there are several additional, non-core variables available (for example, `ACMC` gives the "average cloudiness midnight to midnight from 30-second ceilometer data (percent))." The complete list of available weather variables can be found under 'element' from the GHCND's [readme file](http://www1.ncdc.noaa.gov/pub/data/ghcn/daily/readme.txt). 

While the datasets resulting from functions in this package return a cleaned and aggregated dataset, this journal article by Menne et al. (2012) gives more information aboout the raw data in the GHCND database: 

Menne, M.J., I. Durre, R.S. Vose, B.E. Gleason, and T.G. Houston, 2012:  An overview of the Global Historical Climatology Network-Daily Database.  Journal of Atmospheric and Oceanic Technology, 29, 897-910, doi:10.1175/JTECH-D-11-00103.1. 

### Hourly weather data 

Hourly weather data in this package is pulled from NOAA's Integrated Surface Data (ISD), which is archived at the National Climatic Data Center (NCDC). This data is also pulled through NOAA's FTP server. 

Available hourly weather variables include `wind_direction`, `wind_speed`, `ceiling_height`, `visibility_distance`, `temperature`, `temperature_dewpoint`, and `air_pressure`. 

```{r echo = FALSE}
hourly_vars <- data.frame(variable = c("wind_direction", "wind_speed", 
                                        "ceiling_height", "visibility_distance", 
                                        "temperature", "temperature_dewpoint", 
                                        "air_pressure"), 
                          description = c("The angle, measured in a clockwise direction, between true north and the direction from which the wind is blowing", 
                                          "The rate of horizontal travel of air past a fixed point", 
                                          "The height above ground level of the lowest cloud or obscuring phenomena layer aloft with 5/8 or more summation total sky cover, which may be predominately opaque, or the vertical visibility into a surface-based obstruction", 
                                          "The horizontal distance at which an object can be seen and identified", 
                                          "The temperature of the air", 
                                          "The temperature to which a given parcel of air must be cooled at constant pressure and water vapor content in order for saturation to occur", 
                                          "The air pressure relative to Mean Sea Level"), 
                          units = c("Angular Degrees", "Meters per Second",
                                    "Meters", "Meters", "Degrees Celsuis", 
                                    "Degrees Celsius", "Hectopascals"), 
                          minimum = c("1", "0", "0", "0", "-93.2", "-98.2", "860"), 
                          maximum = c("360", "90", "22000 (indicates 'Unlimited')", "160000", "61.8", 
                                      "36.8", "1090"))
```

```{r warning = FALSE, message = FALSE}
library(knitr)
kable(hourly_vars, format = "markdown")
```

There are other columns available in addition to these weather variables such as quality codes (for example, `wind_direction_quality`). For more information about the weather variables described in the above table and other available columns, see the [ISD documentation file](ftp://ftp.ncdc.noaa.gov/pub/data/noaa/ish-format-document.pdf). 
## Error and warning messages you may get

### Not able to pull data from a monitor

The following error message will come up if there isn't available data (for your specified date range, coverage, and weather variables) for a particular monitor or monitors: 

```
In rnoaa::meteo_pull_monitors(monitors = stations, keep_flags = FALSE,  :
  The following stations could not be pulled from the GHCN ftp:
 USR0000FTEN 
 Any other monitors were successfully pulled from GHCN.
 ```

